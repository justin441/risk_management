{% extends 'risk_register/base.html' %}
{% load i18n humanize %}

{% block title %}
  {% blocktrans with nom=processus.nom %}
    Registre des risques du processus {{ nom }}
  {% endblocktrans %}
{% endblock %}
{% block content %}
  {% block header %}
    {% include 'risk_register/process_card.html' %}
  {% endblock %}
  <ul class="nav nav-tabs nav-justified">
    <li class="nav-item">
      <a href="#risquesprocessus" class="nav-link" role="tab" data-toggle="tab">{% trans 'Risques du processus' %}</a>
    </li>
    <li class="nav-item">
      <a href="#activiterisques" class="nav-link" role="tab" data-toggle="tab">{% trans 'Risques des activités' %}</a>
    </li>
    <li class="nav-item">
      <a href="#activites" class="nav-link active" role="tab" data-toggle="tab">{% trans 'Liste des activités' %}</a>
    </li>
    <li class="nav-item">
      <a href="#inputOutput" class="nav-link" role="tab"
         data-toggle="tab">{% trans "Données d'entrée et de sortie" %}</a>
    </li>
  </ul>

  {% block data %}
    <div class="tab-content">
      <div role="tabpanel" class="tab-pane active mt-3" id="activites">
        {% if processus.activites.all %}
          {% for activite in processus.activites.all %}
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">{{ activite.nom }}</h4>
                <a href="" class="card-link float-right"><span data-feather="settings" class="text-info"></span></a>
                <p class="lead">{{ activite.description }}</p>
                <dl class="row">
                  <dt class="col-sm-3">{% trans Responsable %}</dt>
                  <dd class="col-sm-9">{{ activite.responsable }}</dd>
                  <dt class="col-sm-3"{% trans Statut %}></dt>
                  <dd class="col-sm-9">
                    {% if activite.status == 'completed' %}
                      <span class="text-success">{{ activite.status }}</span>
                    {% else %}
                      <span class="text-info">{{ activite.status }}</span>
                    {% endif %}
                  </dd>
                </dl>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="lead ml-2">{% trans 'Ce processus ne comporte aucune activité' %}</p>
        {% endif %}
      </div>
      <div role="tabpanel" class="tab-pane mt-3" id="risquesprocessus">
        <div class="table-responsive ">
          <table class="table table-striped table-sm" id="processusRisqueTable">
          <thead>
          <tr>
            <th>{% trans 'Ajouté' %}</th>
            <th>{% trans 'Risque' %}</th>
            <th>{% trans 'Ajouté par' %}</th>
            <th>{% trans 'Vérification' %}</th>
            <th>{% trans 'Seuil de risque' %}</th>
            <th>{% trans 'Facteur risque' %}</th>
            <th>{% trans 'Statut du risque' %}</th>
            <th>{% trans 'Propriétaire' %}</th>
            <th>{% trans 'Date de revue' %}</th>
          </tr>
          </thead>
          <tbody>
          {% if processusrisques %}
             {% for processusrisque in processusrisques %}
              <tr>
                <td>{{ processusrisque.created|naturaltime }}</td>
                <td>{{ processusrisque.risque.nom }}</td>
                <td>{{ processusrisque.soumis_par }}</td>
                <td>
                  {% if processusrisque.verifie == 'verified' %}
                    {{ processusrisque.get_verifie_display }}<span data-feather="check" class="text-success"></span>
                    {% else %}
                    <span class="text-danger">{{ processusrisque.get_verifie_display }}</span>
                  {% endif %}
                </td>
                <td class="{{ processusrisque.seuil_display }}">{{ processusrisque.seuil_de_risque|default_if_none:_('Non defini') }}</td>
                <td class="{{ processusrisque.facteur_risque_display }}">{{ processusrisque.facteur_risque|default_if_none:_('Non estimé') }}</td>
                <td class="{{ processusrisque.status_display }}">
                  {% blocktrans with status=processusrisque.status|default_if_none:_('inconnu') %}
                    {{ status }}
                  {% endblocktrans %}
                </td>
                <td><a href="#">{{ processusrisque.get_proprietaire|default_if_none:_('Non assigné') }}</a></td> {# TODO: ajouter l'url#}
                <td>
                  {% if processusrisque.est_obsolete %}
                    <span class="text-danger">{% trans passée %} {{ processusrisque.date_revue|naturaltime  }}</span>
                  {% else %}
                    <span class="text-success">{{ processusrisque.date_revue|naturaltime }}</span>
                  {% endif %}
                </td>
              </tr>
             {% endfor %}
            {% else %}
            <h5>{% trans 'Aucun risque identifié pour les processus de ce Business Unit' %}</h5>
            {% endif %}
          </tbody>

          </table>
        </div>
      </div>
      <div role="tabpanel" class="tab-pane mt-3" id="activiterisques">
        <div class="table-responsive">
          <table class="table table-striped table-sm" id="activiteRisqueTable">
            <thead>
            <tr>
              <th>{% trans 'Ajouté' %}</th>
              <th>{% trans 'Activités' %}</th>
              <th>{% trans 'Risque' %}</th>
              <th>{% trans 'Ajouté par' %}</th>
              <th>{% trans 'Vérification' %}</th>
              <th>{% trans 'Seuil de risque' %}</th>
              <th>{% trans 'Facteur risque' %}</th>
              <th>{% trans 'Statut du risque' %}</th>
              <th>{% trans 'Propriétaire' %}</th>
              <th>{% trans 'Date de revue' %}</th>
            </tr>
            </thead>
            <tbody>
            {% if activiterisques %}
              {% for activiterisque in activiterisques %}
                <tr>
                  <td>{{ activiterisque.created|naturaltime }}</td>
                  <td>{{ activiterisque.activite }}</td>
                  <td>{{ activiterisque.risque.nom }}</td>
                  <td>{{ activiterisque.soumis_par }}</td>
                  <td>
                    {% if activiterisque.verifie == 'verified' %}
                      {{ activiterisque.get_verifie_display }} <span data-feather="check" class="text-success"></span>
                    {% else %}
                      <span class="text-danger">{{ activiterisque.get_verifie_display }}</span>
                    {% endif %}
                  </td>
                  <td
                    class="{{ activiterisque.seuil_display }}">{{ activiterisque.seuil_de_risque|default_if_none:_('Non defini') }}</td>
                  <td
                    class="{{ activiterisque.facteur_risque_display }}">{{ activiterisque.facteur_risque|default_if_none:_('Non estime') }}</td>
                  <td class="{{ activiterisque.status_display }}">
                    {% blocktrans with status=activiterisque.status|default_if_none:_('inconnu') %}
                      {{ status }}
                    {% endblocktrans %}
                  </td>
                  <td><a href="#">{{ activiterisque.get_proprietaire|default_if_none:_('Non assigné') }}</a></td>
                  {# TODO: ajouter l'url#}
                  <td>
                    {% if activiterisque.est_obsolete %}
                      <span class="text-danger">{% trans 'passée' %} {{ activiterisque.date_revue| naturaltime }}</span>
                    {% else %}
                      <span class="text-success">{{ activiterisque.date_revue|naturaltime }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <h5>{% trans 'Aucun risque identifié pour les activités de ce Business Unit' %}</h5>
            {% endif %}
            </tbody>

          </table>
        </div>
      </div>
      <div role="tabpanel" class="tab-pane mt-3" id="inputOutput">
        <div class="row">
          <div class="col">
            <table class="table table-sm">
              <thead class="thead-light">
              <tr>
                <th>{% trans "Données d'entrée" %}</th>
                <th>{% trans "Fournisseurs" %}</th>
              </tr>
              </thead>
              <tbody>
              {% if processus.input_data.all %}
                {% for processdata in processus.input_data.all %}
                  <tr>
                  <td>{{ processdata.nom }}</td>
                  <td>
                    {% if processdata.origine %}
                      <a href="{% url 'risk_register:detail_processus' pk=processdata.origine.code_processus %}">{{ processdata.origine}}</a>
                    {% else %}
                      {{ processdata.commentaire}}
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              {% else %}
               {% trans "Aucune donnée d'entrée" %}
              {% endif %}
              </tbody>
            </table>
          </div>
          <div class="col">
            <table class="table table-sm">
              <thead class="thead-light">
                <tr>
                  <th>{% trans "Données de sortie" %}</th>
                  <th>{% trans "Clients" %}</th>
                </tr>
              </thead>
              <tbody>
                {% if processus.ouput_data.all %}
                  {% for dataprocess in processus.ouput_data.all %}
                    <tr>
                      <th>{{ dataprocess.nom }}</th>
                      <th>
                        {% if dataprocess.clients.all %}
                          {% for process in dataprocess.clients.all %}
                            <a href="{% url 'risk_register:detail_processus' pk=processdata.origine.code_processus %}">{{ process.nom }}</a>;
                          {% endfor %}
                        {% else %}
                          {{ dataprocess.commentaire|default_if_none:_('Client externe') }}
                        {% endif %}
                      </th>
                    </tr>
                  {% endfor %}
                {% else %}
                  {% trans "Aucune donnée de sortie" %}
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  {% endblock %}
{% endblock %}
